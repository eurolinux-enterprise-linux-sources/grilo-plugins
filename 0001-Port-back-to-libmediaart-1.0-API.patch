From cd304eb8ce67c33ebedea9580ea087354a2fb7a0 Mon Sep 17 00:00:00 2001
From: Bastien Nocera <hadess@hadess.net>
Date: Thu, 3 Sep 2015 17:03:15 +0200
Subject: [PATCH] Port back to libmediaart-1.0 API

---
 configure.ac                            | 2 +-
 src/local-metadata/grl-local-metadata.c | 6 +++++-
 2 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/configure.ac b/configure.ac
index 952f806..cee0fef 100644
--- a/configure.ac
+++ b/configure.ac
@@ -154,7 +154,7 @@ PKG_CHECK_MODULES([JSON], [json-glib-1.0], HAVE_JSON_GLIB=yes, HAVE_JSON_GLIB=no
 
 PKG_CHECK_MODULES(AVAHI, [avahi-gobject avahi-glib avahi-client], HAVE_AVAHI=yes, HAVE_AVAHI=no)
 
-PKG_CHECK_MODULES(MEDIAART, [libmediaart-2.0], HAVE_MEDIAART=yes, HAVE_MEDIAART=no)
+PKG_CHECK_MODULES(MEDIAART, [libmediaart-1.0], HAVE_MEDIAART=yes, HAVE_MEDIAART=no)
 
 PKG_CHECK_MODULES(GOM, [gom-1.0 >= 0.2.1], HAVE_GOM=yes, HAVE_GOM=no)
 
diff --git a/src/local-metadata/grl-local-metadata.c b/src/local-metadata/grl-local-metadata.c
index 45856be..e79ec7c 100644
--- a/src/local-metadata/grl-local-metadata.c
+++ b/src/local-metadata/grl-local-metadata.c
@@ -774,6 +774,7 @@ resolve_album_art (GrlSource *source,
                    resolution_flags_t flags)
 {
   const gchar *artist, *album;
+  char *cache_path = NULL;
   char *cache_uri = NULL;
 
   artist = grl_media_audio_get_artist (GRL_MEDIA_AUDIO (rs->media));
@@ -782,13 +783,16 @@ resolve_album_art (GrlSource *source,
   if (!artist || !album)
     return TRUE;
 
-  media_art_get_path (artist, album, "album", &cache_uri);
+  media_art_get_path (artist, album, "album", NULL, &cache_path, NULL);
+  cache_uri = g_filename_to_uri (cache_path, NULL, NULL);
 
   if (cache_uri)
     grl_media_set_thumbnail (rs->media, cache_uri);
   else
     GRL_DEBUG ("Found no thumbnail for artist %s and album %s", artist, album);
 
+  g_free (cache_uri);
+
   rs->callback (rs->source, rs->operation_id, rs->media, rs->user_data, NULL);
 
   g_free (cache_uri);
-- 
2.4.3

